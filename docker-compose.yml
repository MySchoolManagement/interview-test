version: "3.4"

services:
  # --- Backend (PHP + Nginx) ---
  php:
    build:
      context: .
      dockerfile: backend/Dockerfile
    volumes:
      - ./backend/:/var/www/html
    command: sh -c "composer install && php-fpm"
    environment:
      MERCURE_URL: 'http://mercure/.well-known/mercure'
      MERCURE_PUBLIC_URL: 'http://localhost:3000/.well-known/mercure'
      MERCURE_JWT_SECRET: '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'
      DATABASE_URL: 'postgresql://app:app@database:5432/app?serverVersion=15&charset=utf8'
    depends_on:
      - database
      - mercure

  nginx:
    image: nginx:alpine
    ports:
      - "8000:80"
    volumes:
      - ./backend/:/var/www/html
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - php

  database:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: app
      POSTGRES_PASSWORD: app
      POSTGRES_USER: app
    ports:
      - "5432:5432"

  # --- WebSockets (Mercure) ---
  mercure:
    image: dunglas/mercure
    restart: unless-stopped
    environment:
      SERVER_NAME: ':80'
      MERCURE_PUBLISHER_JWT_KEY: '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'
      MERCURE_SUBSCRIBER_JWT_KEY: 'MIIJKQIBAAKCAgEAs7lSTFxXUDKKzZlqL1s1ssH2GOMdVZv1HPDCo4q66S5/d+Nk1IEh1NlYL2r/mQyjmXKbQS+Y5Eg8odkcjcU6hjlXGtn5tDbloyd80byfeJds5MyaDAnrWDH6oCAN9EPVl5qjQ8fgjaSgAxnJVrOMtxiyQOaXSNg1djFPdOpVmRJTsjffo/wWzyWj3Jjb2uMCK3Z8E1kLHQushoU99wcJa6q2z2ylcq+fHQvCiBNVGFnKMaw1FGkNcmTKBbHEThoiTa4ByDA6WXgmYfmbYIHzvYz/dDcd2A4WhJ53F5HT9luWpRqJ5FisWEyb1JYPNzl1hKW9k7oVGG/GdtODpu33e4L506A3jJIn9rZ7h/6kbJnS456PHyjI7PM67oBqbUKSr87yR7B4r6MejG5T1hpg9xrIqoFipG2/ZVCcRTAWqPkjtf2+wbtWame/fh5M0bZrbVUYCRWFWqNVYQJfVZLDf3oIIJpimGGPEXC+KRqoeO0mvfjHoKl+eUwqLCDLPAiRLTc63VXOYfu3Vhqmufxnhx3fxGCHsUugp3Qk8f89/lyDHjsUjHH7grz88N5fxw3iYclXIvAhySsG/04TBaqBIKIDxPn6Khkk13mBKfKe5d6yflLuGsWcUTpYNqTaBKgH50W72qGTg52RE1m7cb5EkJAvy5sDIMKXN/7ebDzHUo8CAwEAAQKCAgAC7Ligon4PQYtNtjnqpF7W1l41YHjJPFz8SBS6yZaqFcYgQtSQurs8tf6/4stfB7wf0qQhJu+jg2NtNNXIntWJeqRmvPZZzuzkv09CMIId2cT9YjD9kinAySttcKgZegMfUPZoM3f9hhjOhBxpK0nWbvHzqWz70/zmu/2xhuC2uXwgMdWTWxZZ76BfhiNJyBjwcSCqxe+u3NJFbCSqgPRPyrrn3DpDCAWcWOUlBr+DQm7OaSGCAAWmf2pkNlTd+oHlZrgDtHk2nIRvYrr7EpJPWtyLXRxAuFX4eYWxnf9nim0Eqc5lp2XCmBiPGJQNz4MQkgvoPAZ829DMfTuuuz+kPVdXEr50fX5Mxi9f0iEo0deSUOF52W6hPD62QY4WPW8cgd7pFo0UzMQyhuoihFkXmyq4Yt3skLn70SiYJBYPosiiIeTdM1gtYL06UGvtFsQBvFLeR5N58palLb7+TQL8eCjl/GcjYW/GTznzxCBjk3SYRg/1LD6f8two3IGaX5ztHAo+FEc1vIuBWr8Zy4ffGdfNFHIlu3VB9hLZ6qDz6UppLXG5ITGDNquoDD7rpkm3XhkELjxzCBZI2zJSGCZsBinS5mNeyNXOusg4cuh7NZF4S6M67FbBVK1WBVGq0L7REdge8Rg4kS7Ympml4vx8tGoUcReVZ7HDaMqgBZuWiQKCAQEA+zjkdIwyNN5XVcrqPvo3u98kfL0OJJ6Pnk0ivSUYsmuptIUo6DEOy3zMAzUDfLf918fVRER9o2MHbjNp2C30MBHL1pbbXGgZVsWP8brP61jTa77PiirjTzhkYqa6ozlOaCog9U/csphvdSUqDuzUNQYMMeNIeI+HyxOdKzrTHlWcWmGIiHaR/gvrWOTagLf+13Suxm0tHHIkQpPYu4swK10jZhZN9UZg9S+UC1KXbItChg/XXpJ3qG0iANP6WCAuWiV1s8BVDipsWdgZW8inP3OCp+EVpuPjz2DmmqoKHZVTVYPq7WvFlbn9TyflfJDE03UoVwVHie9+Uh3VqmMIeQKCAQEAtyRUkPVZLTXgEkgyz6HRQEYKoqaQf4y9YHad+LeEchA7/vYxCM8qTOQNNBzrOUxUiKfi5mPHVuQY9aJGHeQ2Uqq3+oJ9yNEZRxRSWpmQz0AWiBvAGUYtYacvLYq/Lh7mQ1i+KYtIsAGdireaVMmEWf30OsZIikahdJSGZekDNQ1s3XwMTks0/EqWBfBPbdfycLA71CNa318jsv31Q31jMmQoO9+AZb/0usBZIJdaTo9A6acA2zhcTZjMQ3t2vt8qEagLxdxqiXSztqft33cKpF0j9/oK3URy1b4i4CK+jWqUvWeimZePmz55MI/UmIGVCEXGJldDXwVQpS7PZ6OBRwKCAQEA3AvNL7jNETnfTapa26bXwpuFni0KglDQg1wVHY+svjtHfnNUjWzLBLnfCMAaudd/ZM4Io69KTR6kl4Y5I728sY4k+WVR5vLXnwWVO6riC8bWCP4tU1yVlgJTC4X23JmJb/vWuoilS1nx5q4S1NfkWD1f2SK3i8JMszgO5pqz6VIbjZ74tG8HGXrfPhHWwgBoG9h8bhma9duUnyxZHoygOJtwMi8/QaPPsXNnPTOupsikEEE36AJrBP/yVL9X/HDTqOo+2p+Q4MOP/HIoZBixRgarXtjs2i2qkS7TTo26JodxYuoVkLhhbPBoTDkp7Z3wiTeJig95xfwcrVismn38IQKCAQAfT+nZgulFTpHJ7mgpkcwaBh+pYXsRI7n5NS6bKJ1PdzEazXLiw7DCxrbvMwaQnFlTqAimRWb+ly8hSCZe0/bpuWCNRyREYmPFAFd4QAs/NADmMoBskdAOgywQyEkZlJTf7NtOdQ7vcMdDwVJ0rqOfU0kfh2k9owfVy9MSt30h4/K6B4x/EmKzw/jUeRrLeAFufOMtyQGvcS/EWaFGcbi1E+TBH9xvCRvJljtm1BnPlrSNfk0qLf+yEK7T1tcdmUAzFp00rhPU/ov/bcTA0TSTl40fx7N1008i9kg2NBqKSS+3FnH5eq1F6K+FuwGpNXaKnItdYMwXAeyg4Vj6qjzfAoIBAQDBF5rtGFzY6lDU6eef1VCWWkH7TGxdlP+1E73Zr7asrpCL/ZTwz82EwvV21h2iNmgM2HwfM9T9TSAsBr48GiRRL6LhLQ4TOYOOK8roIxRnumPRf213HEP7WDqUlFMKcnv+STFYfINLyD3vhoVh17/nIhDFb9jd0QSAfG+ri+wFjfnXK/3AovzHZgKPl4SE8vIv8V7jBRCjZwQhQy0+FnhpB7pYIvEKTEwkxIuOhbAXDbVkrPYk8rji4X5Mj4zBQrUSEvJFOfngG+MpQOSsDB62lqCLxvshguVrqiYQenBUL794U+dDLkyBVOlzCeqhDanjUToG/kPNPOX8a/RxoIlQ'
      MERCURE_EXTRA_DIRECTIVES: |
        anonymous
        cors_origins *
    ports:
      - "3000:80"
    command: /usr/bin/caddy run --config /etc/caddy/Caddyfile

  # --- Frontend (React) ---
  frontend:
    image: node:18-alpine
    working_dir: /app
    volumes:
      - ./frontend:/app
    command: sh -c "npm install && npm run dev -- --host"
    ports:
      - "5173:5173"
